<!DOCTYPE html>
<html lang="fr" class="h-screen">

<head>
    <include href="themes/base/partials/_head.html" />
</head>

<body class="h-screen flex flex-col">
    <!-- HEADER + progress bar -->
    <header class="flex-none relative">
        <div class="w-full h-1.5 bg-base-200">
            <div id="progress-fill" class="h-full bg-warning w-0"></div>
        </div>
    </header>

    <!-- CAROUSEL -->
    <main class="flex-1 overflow-hidden">
        <div id="carousel" class="carousel w-full h-full overflow-hidden">

            <!-- Slide 1 : Sécurité -->
            <div id="slide1" class="carousel-item relative w-full h-full flex items-center justify-center">
                <div class="max-w-4xl w-full" hx-get="/kpi/securite" hx-trigger="load">
                </div>
            </div>

            <!-- Slide 2 : Environnement -->
            <div id="slide2" class="carousel-item relative w-full h-full flex items-center justify-center">
                <div class="max-w-4xl w-full" hx-get="/kpi/environnement" hx-trigger="load">
                </div>
            </div>

        </div>
    </main>

    <!-- Indicateur flottant Pause/Play -->
    <div id="pauseIndicator"
        class="fixed invisible bottom-4 right-4 bg-gray-800 text-white p-2 rounded shadow-lg flex items-center gap-2 z-50">
        <span id="pauseIcon" class="text-xl">⏸</span>
        <span id="pauseText">Pause</span>
    </div>

    <script>
        document.addEventListener("DOMContentLoaded", () => {
            const carousel = document.getElementById("carousel");
            const slides = Array.from(carousel.querySelectorAll(".carousel-item"));
            const bar = document.getElementById("progress-fill");
            const indicator = document.getElementById("pauseIndicator");
            const icon = document.getElementById("pauseIcon");
            const text = document.getElementById("pauseText");
            let current = 0,
                paused = false,
                timer,
                hideTimeout;

            function showSlide(i) {
                slides[i].scrollIntoView({ behavior: "smooth", inline: "start" });
                current = i;
            }

            function nextSlide() {
                showSlide((current + 1) % slides.length);
                resetProgress();
            }

            function resetProgress() {
                bar.style.transition = "none";
                bar.style.width = "0";
                setTimeout(() => {
                    bar.style.transition = "width 30s linear";
                    bar.style.width = "100%";
                }, 50);
            }

            function startTimer() {
                timer = setInterval(nextSlide, 30000);
                resetProgress();
            }

            function stopTimer() {
                clearInterval(timer);
                bar.style.transition = "";
            }

            function showIndicator() {
                clearTimeout(hideTimeout);
                indicator.classList.remove("invisible");
                hideTimeout = setTimeout(() => {
                    indicator.classList.add("invisible");
                }, 2000);
            }

            // Initialisation
            showSlide(0);
            startTimer();

            document.addEventListener("keydown", (e) => {
                if (e.code === "Space") {
                    e.preventDefault();
                    if (paused) {
                        showSlide((current + 1) % slides.length);
                    } else {
                        nextSlide();
                    }
                }
                if (e.code === "KeyP") {
                    e.preventDefault();
                    paused = !paused;
                    if (paused) {
                        stopTimer();
                        icon.textContent = "⏸";
                        text.textContent = "Pause";
                    } else {
                        startTimer();
                        icon.textContent = "▶️";
                        text.textContent = "Play";
                    }
                    showIndicator();
                }
            });
        });

        document.addEventListener("reload-page", function () {
            location.reload();
        });
    </script>
</body>

</html>