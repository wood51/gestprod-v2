<button class="btn btn-ghost" popovertarget="popover-ref" style="anchor-name: --anchor-ref">
  <i class="fa-solid fa-filter"></i>
</button>

<form
  method="post"
  hx-post="/test/filter"
  hx-swap="none"
  hx-on:htmx:after-request="this.hidePopover()"
  id="popover-ref"
  class="dropdown dropdown-end bg-base-100 p-3 shadow-md text-xs font-normal w-64"
  popover
  style="position-anchor: --anchor-ref"
>
  <!-- Tri + reset -->
  <div class="space-y-1 mb-2">
    <button type="button" class="btn btn-ghost btn-xs justify-start w-full"><i class="fa-solid fa-caret-up mr-2"></i> Trier de A à Z</button>
  </div>
  <div class="space-y-1 mb-2">
    <button type="button" class="btn btn-ghost btn-xs justify-start w-full"><i class="fa-solid fa-caret-down mr-2"></i> Trier de Z à A</button>
  </div>
  <hr class="space-y-1 mb-2" />
  <div class="space-y-1 mb-2">
    <button type="button" class="btn btn-ghost btn-xs justify-start w-full"><i class="fa-solid fa-filter-circle-xmark mr-2"></i> Effacer les filtres</button>
  </div>
  <hr class="space-y-1 mb-2" />
  <!-- Recherche -->
  <div class="space-y-1 mb-2">
    <input type="text" class="input input-xs" placeholder="Rechercher..." />
  </div>
  <!-- Liste scrollable -->
  <div class="overflow-y-auto max-h-40 pr-1 mb-2">
    <ul class="space-y-1">
      <li class="flex items-center gap-2">
        <input type="checkbox" class="check-all" />
        <span>Tout Sélectionner</span>
      </li>

      <repeat group="{{@references}}" value="{{@reference}}">
        <li class="flex items-center gap-2">
          <i class="fa-solid fa-chevron-right text-xs opacity-70"></i>
          <input type="checkbox" name="ref[]" value="{{@reference}}" />
          <span>{{@reference}}</span>
        </li>
      </repeat>
    </ul>
  </div>

  <!-- Boutons -->
  <div class="flex justify-between gap-2">
    <!-- <button type="submit" class="btn btn-primary btn-xs">Envoyer</button> -->
    <button type="submit" class="btn btn-primary btn-xs">
      <span>Envoyer</span>
    </button>
    <button type="reset" class="btn btn-outline btn-xs" onclick="this.closest('[popover]').hidePopover()">Annuler</button>
  </div>
</form>

<!-- JS scoped -->
<script>
  (() => {
    const root = document.getElementById("popover-ref");
    if (!root) return;

    const searchInput = root.querySelector(".filter-search");
    const allCheckbox = root.querySelector(".check-all");
    const checkboxes = root.querySelectorAll(".filter-checkbox");

    // Recherche dynamique
    searchInput?.addEventListener("input", () => {
      const val = searchInput.value.toLowerCase();
      checkboxes.forEach((cb) => {
        const label = cb.nextElementSibling?.textContent.toLowerCase();
        cb.closest("li").style.display = label.includes(val) ? "" : "none";
      });
    });

    // Tout cocher/décocher
    allCheckbox?.addEventListener("change", () => {
      checkboxes.forEach((cb) => {
        cb.checked = allCheckbox.checked;
        cb.dispatchEvent(new Event("change", { bubbles: true }));
      });
    });
  })();
</script>
